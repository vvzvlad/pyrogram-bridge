# Test Plan

## `config.py`

### `get_settings()`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
    *   **–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:**
        *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`TG_API_ID`, `TG_API_HASH`, `SESSION_PATH`, `API_HOST`, `API_PORT`, `PYROGRAM_BRIDGE_URL`, `LOG_LEVEL`, `DEBUG`, `TOKEN`, `TIME_BASED_MERGE`, `SHOW_BRIDGE_LINK`, `SHOW_POST_FLAGS`).
        *   –í—ã–∑–≤–∞—Ç—å `get_settings()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (int –¥–ª—è `tg_api_id`, `api_port`; bool –¥–ª—è `debug`, `time_based_merge`, `show_bridge_link`, `show_post_flags`).
    *   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
        *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ `TG_API_ID` –∏ `TG_API_HASH`.
        *   –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
        *   –í—ã–∑–≤–∞—Ç—å `get_settings()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–ª—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`data`, `0.0.0.0`, `8000`, `""`, `INFO`, `False`, `""`, `False`, `False`, `False`).
    *   **–ß–∞—Å—Ç–∏—á–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
        *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `TG_API_ID`, `TG_API_HASH` –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `API_PORT`, `DEBUG="True"`).
        *   –í—ã–∑–≤–∞—Ç—å `get_settings()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—á–∏—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    *   **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É–ª–µ–≤—ã—Ö —Ñ–ª–∞–≥–æ–≤:**
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –±—É–ª–µ–≤—ã—Ö —Ñ–ª–∞–≥–æ–≤ (`DEBUG`, `TIME_BASED_MERGE`, `SHOW_BRIDGE_LINK`, `SHOW_POST_FLAGS`):
            *   `"True"` -> `True`
            *   `"true"` -> `True` (–¥–ª—è `TIME_BASED_MERGE`, `SHOW_BRIDGE_LINK`, `SHOW_POST_FLAGS`)
            *   `"False"` -> `False`
            *   `"anything else"` -> `False`
            *   –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ -> `False`
    *   **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç):**
        *   –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `TG_API_ID`.
        *   –ú–æ–∫–Ω—É—Ç—å `os._exit` –∏ `print`.
        *   –í—ã–∑–≤–∞—Ç—å `get_settings()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `print` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ "TG_API_ID and TG_API_HASH must be set".
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `os._exit(1)` –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç, –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è `TG_API_HASH`.
        *   –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç, –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –æ–±–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
    *   **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤:**
        *   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `tg_api_id` –∏ `api_port` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–∞–∫ `int`.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å –Ω–µ—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `API_PORT` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `8000`.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å –Ω–µ—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `TG_API_ID` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ (–∏–ª–∏ –∫–∞–∫ —ç—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è). *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¢–µ–∫—É—â–∏–π –∫–æ–¥ –≤—ã–∑–æ–≤–µ—Ç `ValueError` –ø—Ä–∏ `int(tg_api_id)`, —ç—Ç–æ —Ç–æ–∂–µ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.*

## `url_signer.py`

### `KeyManager`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, —á—Ç–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏).
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –î–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∫–∏ (`unittest.mock`) –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ –Ω–µ–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π (`os.path.exists`, `open`, `secrets.token_hex`). –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `data` –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–∫–∞—Ç—å —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
    *   **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞:**
        *   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `SECRET_FILE` (`data/media_digest.key`) –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É—è –º–æ–∫ `os.path.exists`).
        *   –ú–æ–∫–Ω—É—Ç—å `secrets.token_hex` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞.
        *   –ú–æ–∫–Ω—É—Ç—å `open` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª.
        *   –í—ã–∑–≤–∞—Ç—å `KeyManager.get_or_create_signing_key()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `secrets.token_hex(32)` –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `open` –±—ã–ª –≤—ã–∑–≤–∞–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏ (`'w'`) –≤ `KeyManager.SECRET_FILE`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ —Ñ–∞–π–ª –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á.
        *   –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∫–æ–≤ `os.path.exists` –∏ `open`.
        *   –í—ã–∑–≤–∞—Ç—å `KeyManager.get_or_create_signing_key()` —Å–Ω–æ–≤–∞.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `secrets.token_hex` –∏ `open` –¥–ª—è –∑–∞–ø–∏—Å–∏ *–Ω–µ* –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã (–∫–ª—é—á –≤–∑—è—Ç –∏–∑ –ø–∞–º—è—Ç–∏ `cls.signing_key`).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª —Ç–æ—Ç –∂–µ –∫–ª—é—á.
    *   **–ß—Ç–µ–Ω–∏–µ –∫–ª—é—á–∞ –∏–∑ —Ñ–∞–π–ª–∞:**
        *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `KeyManager.signing_key = None` –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞ –≤ –ø–∞–º—è—Ç–∏.
        *   –ú–æ–∫–Ω—É—Ç—å `os.path.exists` —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª `True`.
        *   –ú–æ–∫–Ω—É—Ç—å `open` –¥–ª—è —á—Ç–µ–Ω–∏—è (`'r'`) –∏–∑ `KeyManager.SECRET_FILE`, –≤–æ–∑–≤—Ä–∞—â–∞—è –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∫–ª—é—á.
        *   –í—ã–∑–≤–∞—Ç—å `KeyManager.get_or_create_signing_key()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `os.path.exists` –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `open` –±—ã–ª –≤—ã–∑–≤–∞–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `secrets.token_hex` *–Ω–µ* –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª –∫–ª—é—á, –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π –∏–∑ —Ñ–∞–π–ª–∞.
        *   –í—ã–∑–≤–∞—Ç—å `KeyManager.get_or_create_signing_key()` —Å–Ω–æ–≤–∞.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `os.path.exists` –∏ `open` –¥–ª—è —á—Ç–µ–Ω–∏—è *–Ω–µ* –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã (–∫–ª—é—á –≤–∑—è—Ç –∏–∑ –ø–∞–º—è—Ç–∏ `cls.signing_key`).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª —Ç–æ—Ç –∂–µ –∫–ª—é—á.
    *   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ –∏–∑ –ø–∞–º—è—Ç–∏:**
        *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `KeyManager.signing_key` –≤ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
        *   –í—ã–∑–≤–∞—Ç—å `KeyManager.get_or_create_signing_key()`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `os.path.exists`, `open` –∏ `secrets.token_hex` *–Ω–µ* –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `KeyManager.signing_key`.

### `generate_media_digest(url)`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HMAC-SHA1 –¥–∞–π–¥–∂–µ—Å—Ç–∞ –¥–ª—è URL.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `KeyManager.get_or_create_signing_key`, —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤.
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
    *   **–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:**
        *   –ú–æ–∫–Ω—É—Ç—å `KeyManager.get_or_create_signing_key` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `'test_key'`).
        *   –í—ã–∑–≤–∞—Ç—å `generate_media_digest` —Å —Ç–µ—Å—Ç–æ–≤—ã–º URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, `'http://example.com/media.jpg'`).
        *   –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–π HMAC-SHA1 –¥–∞–π–¥–∂–µ—Å—Ç –¥–ª—è `http://example.com/media.jpg` —Å –∫–ª—é—á–æ–º `test_key` –∏ –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–µ 8 —Å–∏–º–≤–æ–ª–æ–≤.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –æ–∂–∏–¥–∞–µ–º—ã–π 8-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç.
    *   **–†–∞–∑–Ω—ã–µ URL:**
        *   –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç —Å –¥—Ä—É–≥–∏–º URL, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–π–¥–∂–µ—Å—Ç –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è.
    *   **–ü—É—Å—Ç–æ–π URL:**
        *   –í—ã–∑–≤–∞—Ç—å `generate_media_digest('')`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º 8-—Å–∏–º–≤–æ–ª—å–Ω—ã–º –¥–∞–π–¥–∂–µ—Å—Ç–æ–º –¥–ª—è –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª—é—á–∞.
    *   **URL —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏:**
        *   –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å URL —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π, –ø—Ä–æ–±–µ–ª–∞–º–∏, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ `url.encode('utf-8')`.

### `verify_media_digest(url, digest)`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–π–¥–∂–µ—Å—Ç–∞.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∂–Ω–æ –º–æ–∫–Ω—É—Ç—å `generate_media_digest`, —á—Ç–æ–±—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç —Ç–µ—Å—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–π –º–æ–∫ –¥–ª—è `KeyManager.get_or_create_signing_key`. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `hmac.compare_digest` –≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã —ç—Ç–æ —É—á–∏—Ç—ã–≤–∞—Ç—å.
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
    *   **–£—Å–ø–µ—à–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:**
        *   –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç `d = generate_media_digest(url)` (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π).
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url, d)`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `True`.
    *   **–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç:**
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url, 'invalid_digest')`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `False`.
    *   **–ù–µ–≤–µ—Ä–Ω—ã–π URL:**
        *   –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç `d = generate_media_digest(url1)`.
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url2, d)` –≥–¥–µ `url1 != url2`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `False`.
    *   **–ü—É—Å—Ç–æ–π –¥–∞–π–¥–∂–µ—Å—Ç:**
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url, '')`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `False`.
    *   **–î–∞–π–¥–∂–µ—Å—Ç `None`:**
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url, None)`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `False`.
    *   **–î–∞–π–¥–∂–µ—Å—Ç –Ω–µ–≤–µ—Ä–Ω–æ–π –¥–ª–∏–Ω—ã:**
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url, 'short')`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `False` (–∏–∑-–∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å –æ–∂–∏–¥–∞–µ–º—ã–º 8-—Å–∏–º–≤–æ–ª—å–Ω—ã–º –¥–∞–π–¥–∂–µ—Å—Ç–æ–º –ø—Ä–∏ `hmac.compare_digest`).
        *   –í—ã–∑–≤–∞—Ç—å `verify_media_digest(url, 'toolongdigest')`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `False`.

## `telegram_client.py`

### `TelegramClient`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –∑–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∫–ª–∏–µ–Ω—Ç–∞ Pyrogram.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª—è–µ—Ç—Å—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`pyrogram.Client`, `config.get_settings`, `os.makedirs`) –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–∑–æ–≤–æ–≤ –º–µ—Ç–æ–¥–æ–≤.
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
    *   **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (`__init__`)**:
        *   –ú–æ–∫–Ω—É—Ç—å `config.get_settings` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.
        *   –ú–æ–∫–Ω—É—Ç—å `os.makedirs`.
        *   –ú–æ–∫–Ω—É—Ç—å `pyrogram.Client`.
        *   –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä `TelegramClient`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `get_settings` –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `os.makedirs` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `session_path` –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ `exist_ok=True`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `pyrogram.Client` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ `name`, `api_id`, `api_hash`, `workdir` –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫.
        *   **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:**
            *   –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–∫ `os.makedirs` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤—ã–∑—ã–≤–∞–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `TelegramClient` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
    *   **–ó–∞–ø—É—Å–∫ (`start`)**:
        *   –ú–æ–∫–Ω—É—Ç—å `self.client` (—ç–∫–∑–µ–º–ø–ª—è—Ä `pyrogram.Client`) —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º `is_connected` –∏ –º–µ—Ç–æ–¥–æ–º `start`.
        *   **–ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω:**
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `self.client.is_connected = False`.
            *   –í—ã–∑–≤–∞—Ç—å `await client.start()`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `self.client.start()` –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   **–ö–ª–∏–µ–Ω—Ç —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω:**
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `self.client.is_connected = True`.
            *   –í—ã–∑–≤–∞—Ç—å `await client.start()`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `self.client.start()` *–Ω–µ* –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   **–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:**
            *   –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–∫ `self.client.start()` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤—ã–∑—ã–≤–∞–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `self.client.is_connected = False`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `await client.start()` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
    *   **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ (`stop`)**:
        *   –ú–æ–∫–Ω—É—Ç—å `self.client` —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º `is_connected` –∏ –º–µ—Ç–æ–¥–æ–º `stop`.
        *   **–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω:**
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `self.client.is_connected = True`.
            *   –í—ã–∑–≤–∞—Ç—å `await client.stop()`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `self.client.stop()` –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   **–ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω:**
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `self.client.is_connected = False`.
            *   –í—ã–∑–≤–∞—Ç—å `await client.stop()`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `self.client.stop()` *–Ω–µ* –±—ã–ª –≤—ã–∑–≤–∞–Ω.
        *   **–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (—Ö–æ—Ç—è `stop` –æ–±—ã—á–Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π, –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å):**
            *   –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–∫ `self.client.stop()` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤—ã–∑—ã–≤–∞–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ).
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `self.client.is_connected = True`.
            *   –í—ã–∑–≤–∞—Ç—å `await client.stop()` –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–∏–ª–∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–æ –Ω–µ –º–µ—à–∞–µ—Ç).

## `post_parser.py`

### `PostParser`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π Telegram –≤ JSON –∏ HTML.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–æ–¥—É–ª—å. –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –º–µ–¥–∏–∞, —Ñ–æ—Ä–≤–∞—Ä–¥—ã, –æ—Ç–≤–µ—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏. –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—à–∏—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–∫–æ–≤ –¥–ª—è `pyrogram.Client.get_messages`, `config.get_settings`, `url_signer.generate_media_digest`, `os.path`, `open`, `json`, `bleach`, `datetime`. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–±—Ä–∏–∫—É –∏–ª–∏ –Ω–∞–±–æ—Ä —Ñ–∏–∫—Å—Ç—É—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `Message` —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏.

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

*   **`__init__(self, client)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å:** –°–æ–∑–¥–∞—Ç—å –º–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `PostParser`, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `self.client` —Ä–∞–≤–µ–Ω –º–æ–∫—É.
*   **`channel_name_prepare(self, channel)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ID –∫–∞–Ω–∞–ª–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü–µ—Ä–µ–¥–∞—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã–π ID –≤–∏–¥–∞ `"-100..."`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `int`.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã–π username (`"mychannel"`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å —á–∏—Å–ª–æ–≤–æ–π ID (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–≤–µ—Ä–æ—è—Ç–Ω–æ, –≤–µ—Ä–Ω–µ—Ç –∫–∞–∫ –µ—Å—Ç—å).
        *   –ü–µ—Ä–µ–¥–∞—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ.
*   **`get_post(self, channel, post_id, output_type, debug)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self.client.get_messages`, `self.channel_name_prepare`, `self._format_html`, `self.process_message`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   **–£—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤ (HTML):**
            *   –ú–æ–∫–Ω—É—Ç—å `get_messages` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ `Message`.
            *   –í—ã–∑–≤–∞—Ç—å `get_post` —Å `output_type='html'`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `channel_name_prepare` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å `channel`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `get_messages` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º –∏ `post_id`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `_format_html` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ `debug`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `process_message` *–Ω–µ* –±—ã–ª –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `_format_html`).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–≤–µ–Ω –∑–Ω–∞—á–µ–Ω–∏—é, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–æ–º—É `_format_html`.
        *   **–£—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤ (JSON):**
            *   –ú–æ–∫–Ω—É—Ç—å `get_messages` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ `Message`.
            *   –í—ã–∑–≤–∞—Ç—å `get_post` —Å `output_type='json'`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `channel_name_prepare` –∏ `get_messages` –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `process_message` –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `_format_html` *–Ω–µ* –±—ã–ª –≤—ã–∑–≤–∞–Ω.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–≤–µ–Ω –∑–Ω–∞—á–µ–Ω–∏—é, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–æ–º—É `process_message`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–≤–µ–Ω –∑–Ω–∞—á–µ–Ω–∏—é, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–æ–º—É `process_message`.
        *   **–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_messages` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ `None` –∏–ª–∏ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.
            *   –í—ã–∑–≤–∞—Ç—å `get_post`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `None`.
        *   **–ù–µ–≤–µ—Ä–Ω—ã–π `output_type`:**
            *   –í—ã–∑–≤–∞—Ç—å `get_post` —Å `output_type='invalid'`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `None` –∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞.
        *   **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ `get_messages`:**
            *   –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–∫ `get_messages` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤—ã–∑—ã–≤–∞–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `get_post` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –ª–æ–≥–∏—Ä—É–µ—Ç –µ–≥–æ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `raise`.
        *   **–í–∫–ª—é—á–µ–Ω Debug:**
            *   –ú–æ–∫–Ω—É—Ç—å `print`.
            *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `Config["debug"] = True`.
            *   –í—ã–∑–≤–∞—Ç—å `get_post`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `print(message)` –±—ã–ª –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ `get_messages`.

#### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

*   **`_get_author_info(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞ (–µ—Å—Ç—å `sender_chat` —Å `title` –∏ `username`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞ (–µ—Å—Ç—å `sender_chat` —Ç–æ–ª—å–∫–æ —Å `title`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å—Ç—å `from_user` —Å `first_name`, `last_name`, `username`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å—Ç—å `from_user` —Ç–æ–ª—å–∫–æ —Å `first_name`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å—Ç—å `from_user` —Ç–æ–ª—å–∫–æ —Å `username`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ `sender_chat` –∏ `from_user`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `"Unknown author"`.
        *   –ü–æ–ª—è —Å `None` –∏–ª–∏ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.
*   **`_generate_title(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ—Å—Ç–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–æ–æ–±—â–µ–Ω–∏–µ "Channel created" (`channel_chat_created=True`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ URL YouTube.
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –¥—Ä—É–≥–æ–π URL.
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ URL –∏ –ø—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.
        *   –¢–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –º–µ–¥–∏–∞ - —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/GIF/–∞—É–¥–∏–æ/–≥–æ–ª–æ—Å/–∫—Ä—É–∂–æ–∫/—Å—Ç–∏–∫–µ—Ä/–æ–ø—Ä–æ—Å/PDF/–¥–æ–∫—É–º–µ–Ω—Ç/webpage. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.
        *   –¢–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –º–µ–¥–∏–∞ –Ω–µ—Ç.
        *   –¢–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤), –±–µ–∑ URL –∏ —Ç–µ–≥–æ–≤.
        *   –¢–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π (–±–æ–ª—å—à–µ 100 —Å–∏–º–≤–æ–ª–æ–≤). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–µ–∑–∫—É –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–æ–±–µ–ª—É –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ "...".
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç URL –∏ HTML-—Ç–µ–≥–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö —É–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∑–∞–≥–æ–ª–æ–≤–∫–∞.
        *   –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è URL/—Ç–µ–≥–æ–≤ –ø—É—Å—Ç–æ–π, –Ω–æ –µ—Å—Ç—å `web_page`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ "üîó Web link".
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–µ—Ä–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è.
*   **`_format_forward_info(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä–µ—Å—ã–ª–∫–µ.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –∏–∑ —á–∞—Ç–∞ —Å `username`.
        *   –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –∏–∑ —á–∞—Ç–∞ –±–µ–∑ `username`.
        *   –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `username`.
        *   –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ `username`.
        *   –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`forward_sender_name`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ (–≤—Å–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã `None`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `None`.
        *   –ü–æ–ª—è `title`, `first_name`, `last_name` –ø—É—Å—Ç—ã–µ –∏–ª–∏ `None`.
*   **`_format_reply_info(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ç–≤–µ—Ç–µ/–∑–∞–∫—Ä–µ–ø–µ.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`message.service`, `reply_to_message`).
        *   –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ —Å `username`.
        *   –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –±–µ–∑ `username`.
        *   –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª–∏–Ω–Ω—ã–π (> 100 —Å–∏–º–≤–æ–ª–æ–≤). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–µ–∑–∫—É.
        *   –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ø—É—Å—Ç–æ–π (`text` –∏ `caption` - `None`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º/–∑–∞–∫—Ä–µ–ø–æ–º. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `None`.
*   **`_extract_reactions(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏ (`message.reactions.reactions`).
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–∞–∫—Ü–∏–π (`message.reactions` - `None`).
        *   –†–µ–∞–∫—Ü–∏–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ (—ç–º–æ–¥–∑–∏).
*   **`_extract_flags(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ –ø–æ—Å—Ç–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self._generate_html_body`, `self.get_channel_username`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`fwd`).
        *   –í–∏–¥–µ–æ/–∞–Ω–∏–º–∞—Ü–∏—è —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º (`video`).
        *   –ü–æ—Å—Ç –±–µ–∑ –º–µ–¥–∏–∞ –∏–ª–∏ –æ–ø—Ä–æ—Å (`no_image`).
        *   –°—Ç–∏–∫–µ—Ä (`sticker`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "—Å—Ç—Ä–∏–º", "–≤–µ–±–∏–Ω–∞—Ä" –∏ —Ç.–¥. (`stream`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–¥–æ–Ω–∞—Ç" (`donat`).
        *   –†–µ–∞–∫—Ü–∏–∏ —Å 30+ ü§° (`clown`).
        *   –†–µ–∞–∫—Ü–∏–∏ —Å 30+ üí© (`poo`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "#—Ä–µ–∫–ª–∞–º–∞", "erid" –∏ —Ç.–¥. (`advert`).
        *   –¢–µ–∫—Å—Ç/–∞—Ç—Ä–∏–±—É—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç http/https —Å—Å—ã–ª–∫–∏ (`link`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è `@channel` (`mention`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∫—Ä—ã—Ç—ã–µ —Å—Å—ã–ª–∫–∏ `t.me/+...` (`hid_channel`).
        *   –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ *–¥—Ä—É–≥–∏–µ* –æ—Ç–∫—Ä—ã—Ç—ã–µ –∫–∞–Ω–∞–ª—ã `t.me/otherchannel` (`foreign_channel`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ *—Ç–µ–∫—É—â–∏–π* –∫–∞–Ω–∞–ª –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ–ª–∞–≥.
        *   –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ñ–ª–∞–≥–æ–≤.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤, –≤—ã–∑—ã–≤–∞—é—â–∏—Ö —Ñ–ª–∞–≥–∏.
*   **`get_channel_username(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ username –∏–ª–∏ ID –∫–∞–Ω–∞–ª–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ß–∞—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º `username` –≤ `usernames`.
        *   –ß–∞—Ç —Å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º `username` –≤ `usernames`, –Ω–æ –µ—Å—Ç—å `username`.
        *   –ß–∞—Ç —Ç–æ–ª—å–∫–æ —Å `username`.
        *   –ß–∞—Ç –±–µ–∑ `username`, –Ω–æ —Å ID –≤–∏–¥–∞ `-100...`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `str(ID)`.
        *   –ß–∞—Ç –±–µ–∑ `username` –∏ —Å –¥—Ä—É–≥–∏–º ID. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `None`.
        *   –û–±—ä–µ–∫—Ç `message` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `chat` –∏–ª–∏ `chat` —Ä–∞–≤–µ–Ω `None`.

#### –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML

*   **`_format_html(self, message, debug)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–±–æ—Ä–∫—É HTML –∏–∑ —á–∞—Å—Ç–µ–π.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self.process_message` –∏ `json.dumps`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –û–±—ã—á–Ω—ã–π –≤—ã–∑–æ–≤ (`debug=False`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `process_message`, —Å–±–æ—Ä–∫—É —Å—Ç—Ä–æ–∫ –∏–∑ `['html']['header']`, `['html']['media']`, `['html']['body']`, `['html']['footer']`.
        *   –í—ã–∑–æ–≤ —Å `debug=True`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ `<pre>` —Å `json.dumps(message)`.
*   **`_format_flags(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ –≤ HTML.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self._extract_flags` –∏ `Config['show_post_flags']`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   `show_post_flags = False`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏.
        *   `show_post_flags = True`, `_extract_flags` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏.
        *   `show_post_flags = True`, `_extract_flags` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–ª–∞–≥–æ–≤. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é `div.message-flags` —Å —Ñ–ª–∞–≥–∞–º–∏.
*   **`_generate_html_header(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML-–∑–∞–≥–æ–ª–æ–≤–∫–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self._format_forward_info`, `self._format_reply_info`, `self._sanitize_html`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ï—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ä–≤–∞—Ä–¥–µ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ `_format_forward_info`.
        *   –ï—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–≤–µ—Ç–µ (–Ω–æ –Ω–µ—Ç —Ñ–æ—Ä–≤–∞—Ä–¥–∞). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ `_format_reply_info`.
        *   –ù–µ—Ç –Ω–∏ —Ñ–æ—Ä–≤–∞—Ä–¥–∞, –Ω–∏ –æ—Ç–≤–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–¥–æ —Å–∞–Ω–∞—Ü–∏–∏).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_sanitize_html`.
*   **`_generate_html_body(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–ª–∞ HTML.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self._add_hyperlinks_to_raw_urls`, `self._format_poll`, `self._sanitize_html`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ï—Å—Ç—å `message.text`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `message.text.html`, –∑–∞–º–µ–Ω—É `\n` –Ω–∞ `<br>`, –≤—ã–∑–æ–≤ `_add_hyperlinks_to_raw_urls`, –æ–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –≤ `div.message-text`.
        *   –ï—Å—Ç—å `message.caption` (—Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç). –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `message.text`.
        *   –ï—Å—Ç—å `message.poll`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_format_poll` –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
        *   –ï—Å—Ç—å `message.channel_chat_created`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `div.message-service`.
        *   –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –æ–ø—Ä–æ—Å–∞.
        *   –ù–µ—Ç —Ç–µ–∫—Å—Ç–∞, –ø–æ–¥–ø–∏—Å–∏, –æ–ø—Ä–æ—Å–∞, —Å–µ—Ä–≤–∏—Å-—Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–¥–æ —Å–∞–Ω–∞—Ü–∏–∏).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_sanitize_html`.
*   **`_generate_html_media(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML –¥–ª—è –º–µ–¥–∏–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self._save_media_file_ids`, `self._get_file_unique_id`, `self.get_channel_username`, `Config['pyrogram_bridge_url']`, `generate_media_digest`, `self._format_webpage`, `self._sanitize_html`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –º–µ–¥–∏–∞ (`PHOTO`, `VIDEO`, `ANIMATION`, `VIDEO_NOTE`, `AUDIO`, `VOICE`, `STICKER`, `DOCUMENT` (–æ–±—ã—á–Ω—ã–π), `DOCUMENT` (PDF)). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ–≥–æ–≤ (`img`, `video`, `audio`) —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ `src` (–≤–∫–ª—é—á–∞—è –ø–æ–¥–ø–∏—Å—å URL), `style`, `controls`.
        *   –ú–µ–¥–∏–∞ –±–µ–∑ `file_unique_id`.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –º–µ–¥–∏–∞.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å `web_page`, –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç/–ø–æ–¥–ø–∏—Å—å. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_format_webpage` –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å `web_page`, –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç/–ø–æ–¥–ø–∏—Å—å. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `_format_webpage` *–Ω–µ* –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_save_media_file_ids` –≤ –Ω–∞—á–∞–ª–µ.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_sanitize_html` –≤ –∫–æ–Ω—Ü–µ.
*   **`_format_webpage(self, webpage, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `Config['pyrogram_bridge_url']`, `self.get_channel_username`, `generate_media_digest`, `self._add_hyperlinks_to_raw_urls`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –û–±—ã—á–Ω–∞—è –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ (—Å `site_name`, `title`, `description`, `display_url`, `photo`).
        *   –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ Telegram (`type="telegram_message"`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–æ–±–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
        *   –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (`site_name`, `title`, `description`, `display_url`, `photo`, `url`).
        *   –û–ø–∏—Å–∞–Ω–∏–µ (`description`) —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ –∏ URL. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É.
        *   –§–æ—Ç–æ –≤ –ø—Ä–µ–≤—å—é (`webpage.photo`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é `img src` —Å –ø–æ–¥–ø–∏—Å—å—é.
        *   –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç `None`.
*   **`_generate_html_footer(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML-–ø–æ–¥–≤–∞–ª–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self._reactions_views_links`, `self._format_flags`, `self._sanitize_html`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ï—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏/–ø—Ä–æ—Å–º–æ—Ç—Ä—ã/—Å—Å—ã–ª–∫–∏ –∏ —Ñ–ª–∞–≥–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±–µ–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π —Å `<br>`.
        *   –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–∞–∫—Ü–∏–∏/–ø—Ä–æ—Å–º–æ—Ç—Ä—ã/—Å—Å—ã–ª–∫–∏.
        *   –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–ª–∞–≥–∏.
        *   –ù–µ—Ç –Ω–∏ —Ç–æ–≥–æ, –Ω–∏ –¥—Ä—É–≥–æ–≥–æ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `<br>` (–¥–æ —Å–∞–Ω–∞—Ü–∏–∏).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_sanitize_html`.
*   **`_add_hyperlinks_to_raw_urls(self, text)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ `<a>` –∫ "—Å—ã—Ä—ã–º" URL.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –¢–µ–∫—Å—Ç –±–µ–∑ URL.
        *   –¢–µ–∫—Å—Ç —Å –æ–¥–Ω–∏–º URL.
        *   –¢–µ–∫—Å—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ URL.
        *   –¢–µ–∫—Å—Ç —Å URL, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–∞ `<a>`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –µ—â–µ —Ä–∞–∑.
        *   –¢–µ–∫—Å—Ç —Å URL –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ç–µ–≥–æ–≤ (`<b>`, `<i>`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è.
        *   –°–ª–æ–∂–Ω—ã–π —Ç–µ–∫—Å—Ç —Å HTML –∏ URL.
        *   –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
*   **`_reactions_views_links(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π, –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –¥–∞—Ç—ã –∏ —Å—Å—ã–ª–æ–∫.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self.get_channel_username`, `Config['pyrogram_bridge_url']`, `Config['show_bridge_link']`, `Config['token']`, `self._sanitize_html`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ï—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ (–æ–±—ã—á–Ω—ã–µ, –ø–ª–∞—Ç–Ω—ã–µ `is_paid`, –∫–∞—Å—Ç–æ–º–Ω—ã–µ `custom_emoji_id`), –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –¥–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏.
        *   –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–∫—Ü–∏–∏/–ø—Ä–æ—Å–º–æ—Ç—Ä—ã.
        *   –ö–∞–Ω–∞–ª —Å `username`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Å—ã–ª–æ–∫ `tg://`, `https://t.me/`.
        *   –ö–∞–Ω–∞–ª —Å ID (`-100...`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Å—ã–ª–æ–∫ `tg://.../c/...`, `https://t.me/c/...`.
        *   `Config['show_bridge_link'] = True`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –±—Ä–∏–¥–∂ —Å —Ç–æ–∫–µ–Ω–æ–º.
        *   `Config['show_bridge_link'] = False`.
        *   –ù–µ—Ç –Ω–∏ —Ä–µ–∞–∫—Ü–∏–π, –Ω–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –Ω–∏ –¥–∞—Ç—ã, –Ω–∏ —Å—Å—ã–ª–æ–∫. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `None`.
        *   –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç `None`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_sanitize_html`.
*   **`_format_poll(self, poll)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –û–±—ã—á–Ω—ã–π –æ–ø—Ä–æ—Å —Å –≤–æ–ø—Ä–æ—Å–æ–º –∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞.
        *   –û–ø—Ä–æ—Å –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.
        *   –ê—Ç—Ä–∏–±—É—Ç `poll.options` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ `None`.
        *   –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–æ–π.
*   **`_get_file_unique_id(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `file_unique_id` –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –í—Å–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ `MessageMediaType` (photo, video, document –∏ —Ç.–¥.).
        *   `MessageMediaType.WEB_PAGE` —Å —Ñ–æ—Ç–æ.
        *   `MessageMediaType.WEB_PAGE` –±–µ–∑ —Ñ–æ—Ç–æ.
        *   –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –º–µ–¥–∏–∞.
        *   `message.media` = `None`.
        *   –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω—É–∂–Ω–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `message.photo` –µ—Å—Ç—å, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç `file_unique_id`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç `None`.
*   **`_save_media_file_ids(self, message)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `file_unique_id` –≤ JSON-—Ñ–∞–π–ª.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `self.get_channel_username`, `os.path.abspath`, `os.path.exists`, `open`, `json.load`, `json.dump`, `datetime.now`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–¥–∏–∞ (–Ω–µ –±–æ–ª—å—à–∏–º –≤–∏–¥–µ–æ).
            *   –§–∞–π–ª `media_file_ids.json` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏ –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö.
            *   –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–≥–æ `file_unique_id` –Ω–µ—Ç. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏.
            *   –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ –∑–∞–ø–∏—Å—å –¥–ª—è —ç—Ç–æ–≥–æ `file_unique_id` —É–∂–µ –µ—Å—Ç—å. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ `added`.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –≤–∏–¥–µ–æ (> 100MB). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–ø–∏—Å—å *–Ω–µ* –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –º–µ–¥–∏–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–ø–∏—Å—å *–Ω–µ* –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
        *   –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å `channel_username`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤—ã—Ö–æ–¥.
        *   –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏/–∑–∞–ø–∏—Å–∏ JSON-—Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
        *   –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `file_unique_id`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
*   **`_sanitize_html(self, html_raw)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∞–Ω–∞—Ü–∏—é HTML.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `HTMLSanitizer` –∏ `CSSSanitizer`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü–µ—Ä–µ–¥–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π HTML —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏ –∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å HTML —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏ (`<script>`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö —É–¥–∞–ª–µ–Ω–∏–µ.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å HTML —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ (`onclick`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö —É–¥–∞–ª–µ–Ω–∏–µ.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å HTML —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º–∏ CSS-—Å—Ç–∏–ª—è–º–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –æ—Å—Ç–∞–ª–∏—Å—å.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å HTML —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º–∏ CSS-—Å—Ç–∏–ª—è–º–∏ (`position: absolute`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö —É–¥–∞–ª–µ–Ω–∏–µ.
        *   –ü–µ—Ä–µ–¥–∞—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π HTML. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ `bleach`.
        *   –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è —Å–∞–Ω–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ `html_raw`.

#### `process_message(self, message)`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–±–æ—Ä–∫—É –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è JSON.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å –≤—Å–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≤—ã–∑–æ–≤—ã (`get_channel_username`, `_generate_title`, `_generate_html_header`, `_generate_html_body`, `_generate_html_media`, `_generate_html_footer`, `_extract_flags`, `_get_author_info`, `_extract_reactions`, `datetime.timestamp`).
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
    *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (—Ç–µ–∫—Å—Ç, –¥–∞—Ç–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏, –º–µ–¥–∏–∞, `media_group_id`, `web_page` –∏ —Ç.–¥.). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –≤ –∏—Ç–æ–≥–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã–∑–æ–≤–æ–≤ –º–æ–∫–æ–≤.
    *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –ø–æ–ª–µ–π.
    *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ `web_page`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–ª—é—á `webpage` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤ (`timestamp` –¥–ª—è –¥–∞—Ç—ã, —Å—Ç—Ä–æ–∫–∞ –¥–ª—è `date_formatted`, —Å–ø–∏—Å–æ–∫ –¥–ª—è `flags`, —Å–ª–æ–≤–∞—Ä—å –¥–ª—è `reactions`, —Å–ª–æ–≤–∞—Ä—å –¥–ª—è `webpage`).

## `rss_generator.py`

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é RSS –∏ HTML –ª–µ–Ω—Ç, –≤–∫–ª—é—á–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–Ω–æ–≥–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pytest-asyncio`. –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å `PostParser`, `pyrogram.Client`, `feedgen.feed.FeedGenerator`, `datetime`, `re`, `config.get_settings`. –ü–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã `Message` –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `PostParser.process_message`.

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

*   **`_create_time_based_media_groups(messages, merge_seconds)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ `media_group_id`, –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª < `merge_seconds`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É —Å `media_group_id` –≤–∏–¥–∞ `"time_..."`.
        *   –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ `media_group_id`, –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª > `merge_seconds`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö (–±–µ–∑ `media_group_id` –∏–ª–∏ –∫–∞–∂–¥–∞—è –≤ —Å–≤–æ–µ–π `"time_..."` –≥—Ä—É–ø–ø–µ, –µ—Å–ª–∏ –∏—Ö >1).
        *   –°–æ–æ–±—â–µ–Ω–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ `media_group_id`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –¥—Ä—É–≥–∏–º–∏ –≥—Ä—É–ø–ø–∞–º–∏ –∏–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
        *   –°–º–µ—à–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: —Å `media_group_id` –∏ –±–µ–∑, —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏.
        *   –ì—Ä—É–ø–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ `media_group_id` –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞.
        *   –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ `messages`.
        *   –°–ø–∏—Å–æ–∫ —Å –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `media_group_id` –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ.
*   **`_create_messages_groups(messages)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ `media_group_id`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ `media_group_id`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã.
        *   –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ —Å `media_group_id`.
        *   –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ `media_group_id`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥—Ä—É–ø–ø–æ–π.
        *   –°–º–µ—à–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
        *   –°–æ–æ–±—â–µ–Ω–∏—è —Å —Å–µ—Ä–≤–∏—Å–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ (`PINNED_MESSAGE`, `NEW_CHAT_PHOTO`, `NEW_CHAT_TITLE`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è.
        *   –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ `messages`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `id` (–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ `processing_groups` –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ –¥–∞—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ (—É–±—ã–≤–∞–Ω–∏–µ).
*   **`_trim_messages_groups(messages_groups, limit)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–µ–∑–∫—É —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø –¥–æ –ª–∏–º–∏—Ç–∞.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø <= `limit`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è —Å–∞–º–∞—è —Å—Ç–∞—Ä–∞—è –≥—Ä—É–ø–ø–∞ (–ø–æ—Å–ª–µ–¥–Ω—è—è –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ `_create_messages_groups`).
        *   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø > `limit`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è —Å–∞–º–∞—è —Å—Ç–∞—Ä–∞—è –∏ —Å–ø–∏—Å–æ–∫ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –¥–æ `limit` —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
        *   –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ `messages_groups`.
        *   `limit = 0` (–∏–ª–∏ –º–µ–Ω—å—à–µ, —Ö–æ—Ç—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –≤ –≤—ã–∑—ã–≤–∞—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö).
*   **`_render_messages_groups(messages_groups, post_parser, exclude_flags, exclude_text)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä—É–ø–ø —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–æ—Å—Ç—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `post_parser.process_message` –∏ `re.compile`/`search`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   **–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–¥–∏–Ω–æ—á–Ω–æ–π –≥—Ä—É–ø–ø—ã:**
            *   –ú–æ–∫–Ω—É—Ç—å `process_message` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
            *   –ü–µ—Ä–µ–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `process_message` –≤—ã–∑–≤–∞–Ω –æ–¥–∏–Ω —Ä–∞–∑.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏ HTML –∏–∑ `header`, `media`, `body`, `footer`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π `date`, `message_id`, `title`, `text`, `author`, `flags` –≤ –∏—Ç–æ–≥–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ.
        *   **–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã:**
            *   –ú–æ–∫–Ω—É—Ç—å `process_message`.
            *   –ü–µ—Ä–µ–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `process_message` –≤—ã–∑–≤–∞–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ `main_message` (–ø–µ—Ä–≤–æ–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –ø–µ—Ä–≤–æ–µ –≤ –≥—Ä—É–ø–ø–µ).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ `html.media` —á–µ—Ä–µ–∑ `<br>`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ `text` —á–µ—Ä–µ–∑ `\\n`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ `html.body` —á–µ—Ä–µ–∑ `<br><br>`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `header`, `footer`, `title`, `date`, `message_id`, `author`, `flags` –æ—Ç `main_message`.
        *   **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `exclude_flags`:**
            *   –ó–∞–¥–∞—Ç—å `exclude_flags="advert,spam"`.
            *   –ü–µ—Ä–µ–¥–∞—Ç—å –ø–æ—Å—Ç—ã —Å —Ñ–ª–∞–≥–∞–º–∏ `advert`, `spam`, `other`, –±–µ–∑ —Ñ–ª–∞–≥–æ–≤.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å—Ç—ã —Å `advert` –∏ `spam` –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã.
            *   –ó–∞–¥–∞—Ç—å `exclude_flags="all"`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø–æ—Å—Ç—ã —Å *–ª—é–±—ã–º–∏* —Ñ–ª–∞–≥–∞–º–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã.
            *   `exclude_flags = None`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.
        *   **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `exclude_text`:**
            *   –ó–∞–¥–∞—Ç—å `exclude_text="–∫—É–ø–∏—Ç—å|–ø—Ä–æ–¥–∞—Ç—å"`.
            *   –ü–µ—Ä–µ–¥–∞—Ç—å –ø–æ—Å—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º "–∫—É–ø–∏—Ç—å —Å–ª–æ–Ω–∞", "–ø—Ä–æ–¥–∞–º –≥–∞—Ä–∞–∂", "–ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç".
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–≤—ã–µ –¥–≤–∞ –ø–æ—Å—Ç–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π (—Ñ–ª–∞–≥ `re.UNICODE`).
            *   `exclude_text = None`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.
        *   **–ò—Ç–æ–≥–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ `date` (—É–±—ã–≤–∞–Ω–∏–µ).
        *   **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ú–æ–∫–Ω—É—Ç—å `process_message` —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–¥–Ω–æ–π –∏–∑ –≥—Ä—É–ø–ø. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –≥—Ä—É–ø–ø–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

*   **`generate_channel_rss(channel, post_parser, client, limit, exclude_flags, exclude_text, merge_seconds)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ–ª–Ω–æ–π RSS –ª–µ–Ω—Ç—ã.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `PostParser` (–∏ –µ–≥–æ –º–µ—Ç–æ–¥—ã `channel_name_prepare`, `get_channel_username`, `client.get_chat`, `client.get_chat_history`), `FeedGenerator`, `datetime`, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`_create_time_based_media_groups`, `_create_messages_groups`, `_trim_messages_groups`, `_render_messages_groups`), `Config`, `create_error_feed`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   **–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_chat` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–Ω–∞–ª–µ (`title`, `username`).
            *   –ú–æ–∫–Ω—É—Ç—å `get_chat_history` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–ø–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö `Message`.
            *   –ú–æ–∫–Ω—É—Ç—å `_render_messages_groups` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–ø–∏—Å–∫–∞ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `PostParser` (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `channel_name_prepare`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `get_chat`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `get_channel_username`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö `FeedGenerator` (`title`, `link`, `description`, `language`, `id`).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `get_chat_history` —Å `limit*2`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_create_time_based_media_groups` (–µ—Å–ª–∏ `Config['time_based_merge']` True).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_create_messages_groups`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_trim_messages_groups`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `_render_messages_groups` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (`exclude_flags`, `exclude_text`).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (`add_entry`) –≤ `FeedGenerator` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (`title`, `link`, `description`, `content`, `pubDate`, `guid`, `author`).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `fg.rss_str(pretty=True)`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–π—Ç–æ–≤ (–µ—Å–ª–∏ `rss_str` –≤–µ—Ä–Ω—É–ª `bytes`).
        *   **–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_chat` —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `USERNAME_INVALID` –∏–ª–∏ `USERNAME_NOT_OCCUPIED`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `create_error_feed` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        *   **–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è `channel_username`:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_channel_username` —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å `None`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `create_error_feed`.
        *   **–î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ `get_chat`:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_chat` —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–∞–ª—å—à–µ.
        *   **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π `limit`:**
            *   –ü–µ—Ä–µ–¥–∞—Ç—å `limit=0` –∏–ª–∏ `limit=201`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `ValueError`.
        *   **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö —ç—Ç–∞–ø–∞—Ö:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_chat_history` –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.
*   **`generate_channel_html(channel, post_parser, client, limit, exclude_flags, exclude_text, merge_seconds)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–æ—Å—Ç–∞–º–∏.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `generate_channel_rss`, –Ω–æ –±–µ–∑ `FeedGenerator`. –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å `PostParser`, `client`, `datetime`, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, `Config`, `create_error_feed`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   **–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:**
            *   –ú–æ–∫–Ω—É—Ç—å `get_chat`, `get_chat_history`, `_render_messages_groups`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ RSS).
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ `_render_messages_groups` –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø–æ–ª–µ `html`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ HTML-—á–∞—Å—Ç–∏ –ø–æ—Å—Ç–æ–≤ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `<hr class="post-divider">`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ HTML.
        *   **–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω / –û—à–∏–±–∫–∞ `channel_username`:**
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `create_error_feed`.
        *   **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π `limit`:**
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `ValueError`.
        *   **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö —ç—Ç–∞–ø–∞—Ö:**
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
*   **`create_error_feed(channel, base_url)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é RSS-–ª–µ–Ω—Ç—ã –æ–± –æ—à–∏–±–∫–µ.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `FeedGenerator`, `datetime`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö `FeedGenerator` (`title`, `link`, `description`, `language`, `id`), —É–∫–∞–∑—ã–≤–∞—é—â–∏—Ö –Ω–∞ –æ—à–∏–±–∫—É.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ (`add_entry`) —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `fg.rss_str(pretty=True)`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–π—Ç–æ–≤.

## `api_server.py`

*   **–¶–µ–ª—å:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, –ª–æ–≥–∏–∫—É –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `FastAPI.TestClient` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤. –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å `TelegramClient`, `PostParser`, `generate_channel_rss`, `generate_channel_html`, `verify_media_digest`, `os`, `magic`, `mimetypes`, `time`, `asyncio`, `json`, `json_repair`, `uvicorn`.

### Middleware

*   **`RequestLoggingMiddleware`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –∫–æ—Å–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ `TestClient`. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `logging` –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –ª—é–±–æ–º—É —ç–Ω–¥–ø–æ–∏–Ω—Ç—É.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏–ª–∏—Å—å –∑–∞–ø–∏—Å–∏ –æ –∑–∞–ø—Ä–æ—Å–µ (`method`, `url`, `headers`, `query params`).
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å –æ —Å—Ç–∞—Ç—É—Å–µ –æ—Ç–≤–µ—Ç–∞.
        *   –í—ã–∑–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å –æ–± –æ—à–∏–±–∫–µ.

### Lifespan Manager (`lifespan`)

*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏ –∫–ª–∏–µ–Ω—Ç–∞.
*   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é. –ú–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ.
*   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã (–∏–¥–µ–∏):**
    *   –ú–æ–∫–Ω—É—Ç—å `client.start`, `client.stop`, `asyncio.create_task`, `task.cancel`.
    *   –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å `TestClient`.
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `client.start` –∏ `asyncio.create_task(cache_media_files)` –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
    *   –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ `TestClient` —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å).
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `task.cancel` –∏ `client.stop` –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ.
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `data/cache`.

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

*   **`mask_sensitive_value(input_str)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°—Ç—Ä–æ–∫–∞ –¥–ª–∏–Ω–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤.
        *   –°—Ç—Ä–æ–∫–∞ –∫–æ—Ä–æ—á–µ 8 —Å–∏–º–≤–æ–ª–æ–≤.
        *   –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
        *   `None`.
*   **`find_file_id_in_message(message, file_unique_id)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∏—Å–∫ `file_id` –ø–æ `file_unique_id` –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å `photo` –∏ —Å–æ–≤–ø–∞–¥–∞—é—â–∏–º `file_unique_id`.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å `video` –∏ —Å–æ–≤–ø–∞–¥–∞—é—â–∏–º `file_unique_id`.
        *   –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è `animation`, `video_note`, `audio`, `voice`, `sticker`, `document`, `web_page.photo`.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–¥–∏–∞, –Ω–æ `file_unique_id` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –º–µ–¥–∏–∞ –∏–ª–∏ —Å `POLL`.
        *   –°–æ–æ–±—â–µ–Ω–∏–µ, –≥–¥–µ –º–µ–¥–∏–∞-–æ–±—ä–µ–∫—Ç (`message.photo`) –µ—Å—Ç—å, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç `file_id`.
*   **`delayed_delete_file(file_path, delay)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `time.sleep` –∏ `os.remove`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `time.sleep` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `delay`.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `os.remove` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `file_path`.
        *   –ú–æ–∫–Ω—É—Ç—å `os.remove` –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏.
*   **`prepare_file_response(file_path, delete_after)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É `FileResponse` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ MIME-—Ç–∏–ø–æ–º.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `os.path.exists`, `magic.Magic`, `mimetypes.guess_type`, `FileResponse`, `BackgroundTask`, `delayed_delete_file`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
            *   `magic` —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç MIME-—Ç–∏–ø.
            *   `magic` –ø–∞–¥–∞–µ—Ç, `mimetypes` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø.
            *   –û–±–∞ –ø–∞–¥–∞—é—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `application/octet-stream`.
            *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `media_type` –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Content-Disposition`.
            *   `delete_after = True`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `FileResponse` —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å `BackgroundTask(delayed_delete_file)`.
            *   `delete_after = False`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `FileResponse` —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ `BackgroundTask`.
        *   –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (`os.path.exists` -> `False`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `HTTPException(404)`.
*   **`download_media_file(channel, post_id, file_unique_id)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–¥–∏–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `client.client.get_messages`, `find_file_id_in_message`, `client.client.download_media`, `os.path`, `os.makedirs`, `json.load`, `json.dump`, `datetime.now`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   **–û–±—ã—á–Ω–æ–µ –≤–∏–¥–µ–æ/—Ñ–∞–π–ª:**
            *   –§–∞–π–ª —É–∂–µ –≤ –∫–µ—à–µ (`os.path.exists(cache_path)` -> `True`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Ç–∏ –∫ –∫–µ—à—É, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `media_file_ids.json`.
            *   –§–∞–π–ª–∞ –Ω–µ—Ç –≤ –∫–µ—à–µ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `get_messages`, `find_file_id_in_message`, `download_media` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç–µ–º `cache_path`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Ç–∏.
        *   **–ë–æ–ª—å—à–æ–µ –≤–∏–¥–µ–æ (>100MB):**
            *   –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (`temp_...`) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Ç–∏ –∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É.
            *   –í—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ—Ç. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `get_messages`, `find_file_id_in_message`, `download_media` —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—É—Ç–µ–º (`temp_...`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Ç–∏.
        *   **–°–æ–æ–±—â–µ–Ω–∏–µ - –æ–ø—Ä–æ—Å (`POLL`).** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç `None`.
        *   **`file_id` –Ω–µ –Ω–∞–π–¥–µ–Ω:** –ú–æ–∫–Ω—É—Ç—å `find_file_id_in_message` -> `None`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `HTTPException(404)`.
        *   **–û—à–∏–±–∫–∞ `get_messages` –∏–ª–∏ `download_media`.** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
        *   **–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `media_file_ids.json`.** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏.
        *   –ö–∞–Ω–∞–ª –∑–∞–¥–∞–Ω –∫–∞–∫ ID (`-100...`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ `int` –ø–µ—Ä–µ–¥ `get_messages`.
*   **`remove_old_cached_files(media_files, cache_dir)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –∫–µ—à–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `datetime.now`, `os.path`, `os.remove`, `os.listdir`, `os.rmdir`, `os.walk`, `os.path.getmtime`, `time.time`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –§–∞–π–ª —Å—Ç–∞—Ä—à–µ 20 –¥–Ω–µ–π. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞, —É–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ `files_removed`, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ —Å–ø–∏—Å–∫–∞ `updated_media_files`.
        *   –§–∞–π–ª –º–ª–∞–¥—à–µ 20 –¥–Ω–µ–π. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è.
        *   –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (`temp_...`) —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ `updated_media_files`.
        *   –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –º–ª–∞–¥—à–µ 1 —á–∞—Å–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è.
        *   –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
        *   –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ `media_files`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏.
*   **`download_new_files(media_files, cache_dir)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `os.path`, `os.makedirs`, `download_media_file`, `asyncio.sleep`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ï—Å—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–Ω–µ—Ç –≤ –∫–µ—à–µ). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `download_media_file` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ, –≤—ã–∑–æ–≤ `asyncio.sleep(1)`.
        *   –í—Å–µ —Ñ–∞–π–ª—ã —É–∂–µ –≤ –∫–µ—à–µ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `download_media_file` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è.
        *   –ï—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (`temp_...`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è.
        *   –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ `media_files`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–ø—É—Å–∫.
        *   –û—à–∏–±–∫–∞ –ø—Ä–∏ `download_media_file`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.
*   **`fix_corrupted_json(file_path)`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ JSON.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `open`, `json_repair.loads`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –£—Å–ø–µ—à–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π (—Å –Ω—É–∂–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏).
        *   –ù–µ—É–¥–∞—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (`json_repair` –ø–∞–¥–∞–µ—Ç). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.
        *   –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.
*   **`cache_media_files()`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–µ—à–µ–º.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é. –ú–æ–∫–Ω—É—Ç—å `os.path`, `open`, `json.load`, `fix_corrupted_json`, `remove_old_cached_files`, `download_new_files`, `asyncio.sleep`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã (–∏–¥–µ–∏):**
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª: —á—Ç–µ–Ω–∏–µ `media_file_ids.json`, –≤—ã–∑–æ–≤ `remove_old_cached_files`, –≤—ã–∑–æ–≤ `download_new_files`, `asyncio.sleep`.
        *   –§–∞–π–ª `media_file_ids.json` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ `delay`.
        *   –§–∞–π–ª `media_file_ids.json` –ø–æ–≤—Ä–µ–∂–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `fix_corrupted_json`, –∑–∞–ø–∏—Å—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ).
        *   –û—à–∏–±–∫–∞ –ø—Ä–∏ `remove_old_cached_files` –∏–ª–∏ `download_new_files`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–∞.
*   **`calculate_cache_stats()`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `os.path`, `os.walk`, `os.path.getsize`, `json.load`, `datetime.now`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –ü—É—Å—Ç–æ–π –∫–µ—à.
        *   –ö–µ—à —Å —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö (–∫–∞–Ω–∞–ª–∞—Ö). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, —Ä–∞–∑–º–µ—Ä–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º.
        *   –ï—Å—Ç—å `media_file_ids.json` —Å –∑–∞–ø–∏—Å—è–º–∏ `added`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç `cache_time_diff_days`.
        *   –ù–µ—Ç `media_file_ids.json` –∏–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π/–±–µ–∑ `added`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `cache_time_diff_days = 0`.
        *   –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è `media_file_ids.json`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

### API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `TestClient`)

*   **–û–±—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞:**
    *   –î–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
        *   `Config["token"]` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–∏–ª–∏ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º) –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ IP -> 403.
        *   `Config["token"]` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–ø—Ä–æ—Å —Å –≤–µ—Ä–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º -> 2xx/4xx/5xx (—É—Å–ø–µ—Ö –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞).
        *   `Config["token"]` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–ø—Ä–æ—Å –æ—Ç localhost -> 2xx/4xx/5xx (—Ç–æ–∫–µ–Ω –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è).
        *   `Config["token"]` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω -> 2xx/4xx/5xx (—Ç–æ–∫–µ–Ω –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è).
*   **`/html/{channel}/{post_id}` –∏ `/post/html/{channel}/{post_id}`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ HTML –ø–æ—Å—Ç–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `PostParser`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ú–æ–∫–Ω—É—Ç—å `parser.get_post` -> `html_string`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 200, `Content-Type: text/html`, —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞.
        *   –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú–æ–∫–Ω—É—Ç—å `parser.get_post` -> `None`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 404.
        *   –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞. –ú–æ–∫–Ω—É—Ç—å `parser.get_post` -> Exception. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 500.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞.
*   **`/json/{channel}/{post_id}` –∏ `/post/json/{channel}/{post_id}`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ JSON –ø–æ—Å—Ç–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `PostParser`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ú–æ–∫–Ω—É—Ç—å `parser.get_post` -> `dict`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 200, `Content-Type: application/json`, —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞.
        *   –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú–æ–∫–Ω—É—Ç—å `parser.get_post` -> `None`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 404.
        *   –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞. –ú–æ–∫–Ω—É—Ç—å `parser.get_post` -> Exception. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 500.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞.
*   **`/health`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `client.client.get_me`, `calculate_cache_stats`, `Config`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ú–æ–∫–Ω—É—Ç—å `get_me` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–±—ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 200, –≤—Å–µ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç–µ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ `config`.
        *   –û—à–∏–±–∫–∞ `get_me`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 500.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞.
*   **`/media/{channel}/{post_id}/{file_unique_id}/{digest}`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `verify_media_digest`, `download_media_file`, `prepare_file_response`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–≤–∞–ª–∏–¥–Ω—ã–π `digest`). –ú–æ–∫–Ω—É—Ç—å `verify_media_digest` -> `True`, `download_media_file` -> `(file_path, delete_after)`, `prepare_file_response` -> `FileResponse`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 200, —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ `FileResponse`.
        *   –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π `digest`. –ú–æ–∫–Ω—É—Ç—å `verify_media_digest` -> `False`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 403.
        *   –û—à–∏–±–∫–∞ `download_media_file` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `HTTPException(404)`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è (404).
        *   –û—à–∏–±–∫–∞ `download_media_file` (–¥—Ä—É–≥–∞—è). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 500.
        *   –û—à–∏–±–∫–∞ `prepare_file_response`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 500.
        *   –û—à–∏–±–∫–∞ `pyrogram.errors.RPCError` –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 404.
*   **`/rss/{channel}`**:
    *   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é RSS/HTML –ª–µ–Ω—Ç—ã.
    *   **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∫–Ω—É—Ç—å `generate_channel_rss`, `generate_channel_html`.
    *   **–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
        *   –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å (`output_type='rss'`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é). –ú–æ–∫–Ω—É—Ç—å `generate_channel_rss`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 200, `Content-Type: application/xml`.
        *   –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å (`output_type='html'`). –ú–æ–∫–Ω—É—Ç—å `generate_channel_html`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 200, `Content-Type: text/html`.
        *   –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π `limit` (`generate_...` –≤—ã–∑—ã–≤–∞–µ—Ç `ValueError`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 400.
        *   –û—à–∏–±–∫–∞ `FloodWait`. –ú–æ–∫–Ω—É—Ç—å `generate_...` –¥–ª—è –≤—ã–∑–æ–≤–∞ `errors.FloodWait`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 429, –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Retry-After`.
        *   –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ú–æ–∫–Ω—É—Ç—å `generate_...` –¥–ª—è –≤—ã–∑–æ–≤–∞ `Exception`. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å 500.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `limit`, `exclude_flags`, `exclude_text`, `merge_seconds` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
        *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞.

--- 